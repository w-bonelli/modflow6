name: MODFLOW 6 release
on:
  push:
    branches:
      - master
      - v*
env:
  FC: ifort
  CC: cl
jobs:
  build:
    name: Build binaries (${{ matrix.os }})
    if: ${{ github.event_name != 'push' || github.ref_name != 'master' }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            ostag: linux
          - os: macos-12
            ostag: mac
          # - os: windows-2022
          #   ostag: win64
    defaults:
      run:
        shell: bash -l {0}
    steps:
      - name: Checkout modflow6
        uses: actions/checkout@v3
        with:
          path: modflow6

      - name: Cache binaries
        if: ${{ contains(github.ref_name, 'rc') }}
        id: cache-bin
        uses: actions/cache@v3
        with:
          key: bin-${{ runner.os }}
          path: modflow6/bin

      - name: Setup Micromamba
        if: ${{ !(contains(github.ref_name, 'rc')) || steps.cache-bin.outputs.cache-hit != 'true' }}
        uses: mamba-org/provision-with-micromamba@main
        with:
          environment-file: modflow6/environment.yml
          cache-downloads: true
          cache-env: true

      - name: Setup Intel Fortran
        if: ${{ !(contains(github.ref_name, 'rc')) || steps.cache-bin.outputs.cache-hit != 'true' }}
        uses: w-bonelli/install-intelfortran-action@develop

      - name: Fix Micromamba path (Windows)
        if: ${{ runner.os == 'Windows' && (!(contains(github.ref_name, 'rc')) || steps.cache-bin.outputs.cache-hit != 'true') }}
        shell: pwsh
        run: |
          # https://github.com/modflowpy/install-intelfortran-action#conda-scripts
          $mamba_bin = "C:\Users\runneradmin\micromamba-root\envs\modflow6\Scripts"
          echo $mamba_bin | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Update version
        if: ${{ !(contains(github.ref_name, 'rc')) || steps.cache-bin.outputs.cache-hit != 'true' }}
        working-directory: modflow6/distribution
        run: |
          ref="${{ github.ref_name }}"
          ver="${ref%"rc"}"
          if [ "$ref" == "$ver" ]; then
            python update_version.py -v "${ver#"v"}" --approve
          else
            python update_version.py -v "${ver#"v"}" 
          fi
          
          # check src/Utilities/version.f90 IDEVELOPMODE setting
          cat ../src/Utilities/version.f90

      - name: Build binaries
        if: ${{ runner.os != 'Windows' && (!(contains(github.ref_name, 'rc')) || steps.cache-bin.outputs.cache-hit != 'true') }}
        working-directory: modflow6
        run: |
          meson setup builddir -Ddebug=false --prefix=$(pwd) --libdir=bin
          meson install -C builddir
          meson test --verbose --no-rebuild -C builddir

      - name: Build binaries (Windows)
        if: ${{ runner.os == 'Windows' && (!(contains(github.ref_name, 'rc')) || steps.cache-bin.outputs.cache-hit != 'true') }}
        working-directory: modflow6
        shell: pwsh
        run: |
          meson setup builddir -Ddebug=false --prefix=$(pwd) --libdir=bin
          meson install -C builddir
          meson test --verbose --no-rebuild -C builddir

      - name: Upload binaries
        uses: actions/upload-artifact@v3
        with:
          name: bin-${{ runner.os }}
          path: modflow6/bin

  docs:
    name: Build docs
    if: ${{ github.event_name != 'push' || github.ref_name != 'master' }}
    needs: build
    runs-on: ubuntu-22.04
    defaults:
      run:
        shell: bash -l {0}
    steps:

      - name: Checkout modflow6
        uses: actions/checkout@v3
        with:
          path: modflow6

      - name: Checkout modflow6-examples
        uses: actions/checkout@v3
        with:
          repository: MODFLOW-USGS/modflow6-examples
          path: modflow6-examples

      - name: Install TeX Live
        run: |
          sudo apt-get update
          sudo apt install texlive-latex-extra texlive-science texlive-font-utils texlive-fonts-recommended texlive-fonts-extra

      - name: Checkout usgslatex
        uses: actions/checkout@v3
        with:
          repository: MODFLOW-USGS/usgslatex
          path: usgslatex

      - name: Install USGS LaTeX style files and Univers font
        working-directory: usgslatex/usgsLaTeX
        run: |
          sudo ./install.sh --all-users

      - name: Setup Micromamba
        uses: mamba-org/provision-with-micromamba@main
        with:
          environment-file: modflow6/environment.yml
          cache-downloads: true
          cache-env: true

      - name: Setup Intel Fortran
        uses: w-bonelli/install-intelfortran-action@develop

      - name: Fix Micromamba path (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          # https://github.com/modflowpy/install-intelfortran-action#conda-scripts
          $mamba_bin = "C:\Users\runneradmin\micromamba-root\envs\modflow6\Scripts"
          echo $mamba_bin | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      # - name: Cache modflow6 examples
      #   id: cache-examples
      #   uses: actions/cache@v3
      #   with:
      #     path: modflow6-examples/examples
      #     key: modflow6-examples-${{ hashFiles('modflow6-examples/scripts/**') }}

      - name: Install extra Python packages
        # if: steps.cache-examples.outputs.cache-hit != 'true'
        working-directory: modflow6-examples/etc
        run: pip install -r requirements.pip.txt

      - name: Build example models
        # if: steps.cache-examples.outputs.cache-hit != 'true'
        working-directory: modflow6-examples/etc
        run: |
          pytest -v -n auto ci_build_files.py
          ls -lh ../examples/ 

      - name: Update version
        working-directory: modflow6/distribution
        run: |
          ref="${{ github.ref_name }}"
          ver="${ref%"rc"}"
          # if tag doesn't end with 'rc' the release is approved
          if [ "$ref" == "$ver" ]; then
            python update_version.py -v "${ver#"v"}" --approve
          else
            python update_version.py -v "${ver#"v"}" 
          fi
          
          echo "DISTNAME=mf${ref#"v"}" >> $GITHUB_ENV

      - name: Create directory structure
        run: |
          # Create a skeleton of the distribution's folder structure to include in the docs
          mkdir -p "$DISTNAME/doc"
          mkdir "$DISTNAME/make"
          mkdir "$DISTNAME/msvs"
          mkdir "$DISTNAME/srcbmi"
          cp modflow6/code.json "$DISTNAME/code.json"
          cp modflow6/meson.build "$DISTNAME/meson.build"
          cp -r modflow6-examples/examples "$DISTNAME"
          cp -r modflow6/src "$DISTNAME"
          cp -r modflow6/utils "$DISTNAME"
          
          # create LaTeX file describing the folder structure
          cd modflow6/doc/ReleaseNotes
          python mk_folder_struct.py -dp "${{ github.workspace }}/$DISTNAME"

      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
          name: bin-${{ runner.os }}
          path: bin

      - name: Build documentation
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          chmod +x bin/mf6
          chmod +x bin/mf5to6
          chmod +x bin/zbud6
          python modflow6/distribution/build_docs.py -b bin -o doc

      - name: Upload documentation
        uses: actions/upload-artifact@v3
        with:
          name: doc
          path: doc

  dist:
    name: Build distribution (${{ matrix.os }})
    if: ${{ github.event_name != 'push' || github.ref_name != 'master' }}
    needs: docs
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            ostag: linux
          - os: macos-12
            ostag: mac
          # - os: windows-2022
          #   ostag: win64
    defaults:
      run:
        shell: bash -l {0}
    steps:
      - name: Checkout modflow6
        uses: actions/checkout@v3
        with:
          path: modflow6

      - name: Checkout modflow6-examples
        uses: actions/checkout@v3
        with:
          repository: MODFLOW-USGS/modflow6-examples
          path: modflow6-examples

      - name: Setup Micromamba
        uses: mamba-org/provision-with-micromamba@main
        with:
          environment-file: modflow6/environment.yml
          cache-downloads: true
          cache-env: true

      - name: Setup Intel Fortran
        uses: w-bonelli/install-intelfortran-action@develop

      - name: Fix Micromamba path (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          # https://github.com/modflowpy/install-intelfortran-action#conda-scripts
          $mamba_bin = "C:\Users\runneradmin\micromamba-root\envs\modflow6\Scripts"
          echo $mamba_bin | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      # - name: Cache modflow6 examples
      #   id: cache-examples
      #   uses: actions/cache@v3
      #   with:
      #     path: modflow6-examples/examples
      #     key: modflow6-examples-${{ hashFiles('modflow6-examples/scripts/**') }}

      - name: Install extra Python packages
        # if: steps.cache-examples.outputs.cache-hit != 'true'
        working-directory: modflow6-examples/etc
        run: |
          pip install -r requirements.pip.txt

      - name: Build example models
        # if: steps.cache-examples.outputs.cache-hit != 'true'
        working-directory: modflow6-examples/etc
        run: |
          pytest -v -n auto ci_build_files.py
          ls -lh ../examples/ 
      
      - name: Update version
        working-directory: modflow6/distribution
        run: |
          ref="${{ github.ref_name }}"
          ver="${ref%"rc"}"
          # if tag doesn't end with 'rc' the release is approved
          if [ "$ref" == "$ver" ]; then
            python update_version.py -v "${ver#"v"}" --approve
          else
            python update_version.py -v "${ver#"v"}" 
          fi
          
          echo "DISTNAME=mf${ref#"v"}" >> $GITHUB_ENV

      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
          path: ${{ env.DISTNAME }}

      - name: Prune artifacts
        run: |
          # move binaries for current OS to top level bin
          # directory and remove executables for other OS
          mv "$DISTNAME/bin-${{ runner.os }}" "$DISTNAME/bin"
          rm -rf "$DISTNAME/bin-*"

      - name: Build distribution
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          if [ "${{ runner.os }}" == "Windows" ]; then
            export PATH="/C/Program Files/Microsoft Visual Studio/2022/Enterprise/VC/Tools/MSVC/14.33.31629/bin/Hostx64/x64":$PATH
          else
            chmod +x "$DISTNAME/bin/mf6"
            chmod +x "$DISTNAME/bin/mf5to6"
            chmod +x "$DISTNAME/bin/zbud6"
          fi
          mkdir modflow6/distribution/.benchmarks
          python modflow6/distribution/build_dist.py -o "$DISTNAME" -e modflow6-examples

      - name: Rename PDF docs, copy code.json, set zip name
        run: |
          # rename PDF docs
          mv "$DISTNAME/doc/ReleaseNotes.pdf" "$DISTNAME/doc/release.pdf"
          mv "$DISTNAME/doc/converter_mf5to6.pdf" "$DISTNAME/doc/mf5to6.pdf"
          
          # copy code.json
          cp modflow6/code.json "$DISTNAME/code.json"
          
          # set zip name
          if [ "${{ runner.os }}" == "Windows" ]; then
            zip_name="${{ env.DISTNAME }}"
          else
            zip_name="${{ env.DISTNAME }}_${{ matrix.ostag }}"
          fi
          echo "ZIP_NAME=$zip_name" >> $GITHUB_ENV

      - name: Set executable permissions
        if: runner.os != 'Windows'
        run: |
          chmod +x "$DISTNAME/bin/mf6"
          chmod +x "$DISTNAME/bin/mf5to6"
          chmod +x "$DISTNAME/bin/zbud6"
          chmod +x "$DISTNAME/examples/runall.sh"
          for f in "$DISTNAME/examples"/*/run.sh; do
            chmod +x "$f"
          done

      - name: Check distribution
        run: pytest -v -s modflow6/distribution/check_dist.py -P ${{ env.DISTNAME }}

      - name: Upload distribution
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.ZIP_NAME }}
          path: |
            ${{ env.DISTNAME }}/bin
            ${{ env.DISTNAME }}/src
            ${{ env.DISTNAME }}/srcbmi
            ${{ env.DISTNAME }}/doc
            ${{ env.DISTNAME }}/examples
            ${{ env.DISTNAME }}/make
            ${{ env.DISTNAME }}/msvs
            ${{ env.DISTNAME }}/utils
            ${{ env.DISTNAME }}/code.json
            ${{ env.DISTNAME }}/meson.build
            !${{ env.DISTNAME }}/utils/idmloader
            !${{ env.DISTNAME }}/bin/libmf6.lib
            !${{ env.DISTNAME }}/**/pymake
            !${{ env.DISTNAME }}/**/.DS_Store
            !${{ env.DISTNAME }}/**/obj_temp
            !${{ env.DISTNAME }}/**/mod_temp

      - name: Upload release notes
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v3
        with:
          name: release_notes
          path: ${{ env.DISTNAME }}/doc/release.pdf

  pr:
    name: Create pull request
    if: ${{ github.event_name == 'push' && !(contains(github.ref_name, 'rc')) }}
    needs: dist
    runs-on: ubuntu-22.04
    permissions:
      contents: write
      pull-requests: write
    defaults:
      run:
        shell: bash -l {0}
    steps:
      - name: Checkout modflow6
        uses: actions/checkout@v3

      - name: Setup Micromamba
        uses: mamba-org/provision-with-micromamba@main
        with:
          cache-downloads: true
          cache-env: true

      - name: Get previous tag
        uses: actions-ecosystem/action-get-latest-tag@v1
        id: previous_tag

      - name: Update version
        working-directory: distribution
        run: |
          # update version files
          ref="${{ github.ref_name }}"
          ver="${ref#"v"}"
          if [ "$ref" == "$ver" ]; then
            python update_version.py -v "$ver" --approve
          else
            python update_version.py -v "$ver" 
          fi
          
          # commit and push
          git config core.sharedRepository true
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "ci(release): update version to $ver"
          git push origin "$ref"

      - name: Create pull request
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          ref="${{ github.ref_name }}"
          ver="${ref#"v"}"
          body='
          # MODFLOW 6 version '$ver' release
          
          To approve this release, merge this pull request. This will trigger a final CI job to:
          - tag the tip of the `master` branch with `'$ver'`
          - rebase the `master` branch onto `develop`
          - reset version files and `IDEVELOPMODE`
          - create a GitHub release
          '
          
          gh pr create -B "master" -H "$ref" --title "Release $ver" --draft --body "$body"

  release:
    name: Release
    if: ${{ github.event_name == 'push' && github.ref_name == 'master' }}
    runs-on: ubuntu-22.04
    defaults:
      run:
        shell: bash -l {0}
    steps:
      - name: Checkout modflow6
        uses: actions/checkout@v3
        with:
          path: modflow6

      - name: Setup Micromamba
        uses: mamba-org/provision-with-micromamba@main
        with:
          cache-downloads: true
          cache-env: true

      - name: Archive source code (zip)
        uses: thedoctor0/zip-release@main
        with:
          path: modflow6
          type: zip
          filename: "Source code (zip)"
          exclusions: '*.git/'

      - name: Archive source code (tar)
        uses: thedoctor0/zip-release@main
        with:
          path: modflow6
          type: tar
          filename: "Source code (tar.gz)"
          exclusions: '*.git/'

      - name: Download artifacts
        uses: dawidd6/action-download-artifact@v2
        with:
          skip_unpack: true

      - name: Unzip/rename release notes
        run: |
          unzip -q release_notes.zip
          mv release_notes.pdf release.pdf

      - name: Draft release
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          ver=$(python distribution/update_version.py --get)
          title="MODFLOW Version $ver"
          notes='
          This is the approved USGS MODFLOW '$ver' release.
          
          *Insert citation here*
          
          Visit the USGS "MODFLOW and Related Programs" site for information on MODFLOW 6 and related software: https://doi.org/10.5066/F76Q1VQV
          '
          
          gh release create "$ver" mf*.zip release.pdf Source* --target master --title "$title" --notes "$notes" --draft --latest 

      - name: Rebase develop and reset version files
        run: |
          # check tag was created 
          git fetch --tags origin
          git tag
      
          # rebase develop
          git checkout develop
          git rebase master

          # reset version files and develop mode
          python distribution/update_version.py
          git add -A
          git commit -m "ci(release): reset version"
          git push origin develop
